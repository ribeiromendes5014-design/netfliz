{% extends "base.html" %}

{% block title %}Painel do Proprietário | Netfliz{% endblock %}

{% block content %}
<section class="panel owner-panel">
  <header>
    <h1>Painel do Proprietário</h1>
    <p>Cadastre os vídeos que todos os tenants poderão assistir e controle quem deve ficar de fora.</p>
  </header>
  <div class="two-columns">
    <div class="video-list-column">
      <h2>Vídeos cadastrados</h2>
      {% if videos %}
      <ul class="video-list">
        {% for video in videos %}
        <li>
          <div>
            <strong>{{ video.title }}</strong>
            <small>{{ video.slug }}</small>
          </div>
          <div class="video-list__actions">
            <a class="btn btn-secondary" href="{% url 'stream:owner-video-edit' video.pk %}">Editar</a>
            <a class="btn btn-accent" href="{% url 'stream:owner-video-delete' video.pk %}">Excluir</a>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="catalog-empty">Nenhum vídeo cadastrado ainda.</p>
      {% endif %}
      <section class="series-list-section">
        <h2>Séries cadastradas</h2>
        {% if series_list %}
        <ul class="series-list">
          {% for series in series_list %}
          <li>
            <div>
              <strong>{{ series.title }}</strong>
              <small>{{ series.slug }}</small>
            </div>
            <span class="series-status {% if series.is_active %}series-status--active{% else %}series-status--inactive{% endif %}">
              {{ series.is_active|yesno:"Ativa,Oculta" }}
            </span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="catalog-empty">Nenhuma série cadastrada.</p>
        {% endif %}
      </section>
    </div>
    <div class="video-form-column">
      <div class="dashboard-tabs" role="tablist">
        <button type="button" class="dashboard-tab is-active" data-dashboard-tab="content" role="tab" aria-selected="true">
          Conteúdo
        </button>
        <button type="button" class="dashboard-tab" data-dashboard-tab="series" role="tab" aria-selected="false">
          Série
        </button>
      </div>
      <section class="series-form" data-dashboard-section="series" hidden>
        <h2>Cadastrar nova série</h2>
        <form method="post" id="series-form">
          {% csrf_token %}
          {{ series_form.non_field_errors }}
          {% for field in series_form %}
          <div class="form-row">
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}
            <small class="form-hint">{{ field.help_text }}</small>
            {% endif %}
            {{ field.errors }}
          </div>
          {% endfor %}
          <button class="btn btn-secondary" type="submit" name="series-submit">Salvar série</button>
        </form>
      </section>
      <section class="video-form" data-dashboard-section="content" hidden>
        <h2>Cadastrar novo conteúdo</h2>
        <div class="video-category-tabs" role="tablist" aria-label="Tipo de conteúdo">
          <button type="button" class="category-tab is-active" data-category-tab="tv" role="tab" aria-selected="true">TV</button>
          <button type="button" class="category-tab" data-category-tab="movie" role="tab" aria-selected="false">Filme</button>
          <button type="button" class="category-tab" data-category-tab="series" role="tab" aria-selected="false">Série</button>
        </div>
        <form method="post" id="video-form">
          {% csrf_token %}
          {{ video_form.non_field_errors }}
          <div class="form-section general">
            <div class="form-grid two-columns">
              <div class="form-field">
                {{ video_form.title.label_tag }}
                {{ video_form.title }}
                <small class="form-hint">{{ video_form.title.help_text }}</small>
                {{ video_form.title.errors }}
              </div>
              <div class="form-field">
                {{ video_form.cover_url.label_tag }}
                {{ video_form.cover_url }}
                <small class="form-hint">{{ video_form.cover_url.help_text }}</small>
                {{ video_form.cover_url.errors }}
              </div>
            </div>
            <div class="form-field">
              {{ video_form.source_url.label_tag }}
              {{ video_form.source_url }}
              <small class="form-hint">{{ video_form.source_url.help_text }}</small>
              {{ video_form.source_url.errors }}
            </div>
            <div class="form-grid two-columns">
              <div class="form-field">
                {{ video_form.video_type.label_tag }}
                {{ video_form.video_type }}
                {{ video_form.video_type.errors }}
              </div>
              <div class="form-field visually-hidden">
                {{ video_form.category.label_tag }}
                {{ video_form.category }}
              </div>
            </div>
            <div class="form-grid">
              <div class="form-field">
                {{ video_form.slug.label_tag }}
                {{ video_form.slug }}
                {{ video_form.slug.errors }}
              </div>
            </div>
            <div class="form-grid">
              <div class="form-field">
                {{ video_form.rotate_180.label_tag }}
                {{ video_form.rotate_180 }}
                {{ video_form.rotate_180.errors }}
              </div>
            </div>
            <div class="form-field">
              {{ video_form.description.label_tag }}
              {{ video_form.description }}
              {{ video_form.description.errors }}
            </div>
          </div>
          <div class="form-section section-tv" data-section="tv">
            <p class="section-description">Conteúdos ao vivo podem ser cadastrados com o link do embed ou do stream direto. Abra o canal e deixe o botão “Reproduzir” pronto para o controle.</p>
          </div>
          <div class="form-section section-movie" data-section="movie">
            <p class="section-description">Filmes pedem um título, gênero e descrição curta para exibição no catálogo.</p>
            <div class="form-field">
              {{ video_form.genre.label_tag }}
              {{ video_form.genre }}
              <small class="form-hint">{{ video_form.genre.help_text }}</small>
              {{ video_form.genre.errors }}
            </div>
          </div>
          <div class="form-section section-series" data-section="series">
            <p class="section-description">As séries incluem temporada, episódio e vínculo com uma série cadastrada. Use os campos abaixo para organizar a sequência.</p>
            <div class="form-grid two-columns">
              <div class="form-field">
                {{ video_form.series.label_tag }}
                {{ video_form.series }}
                {{ video_form.series.errors }}
              </div>
              <div class="form-field series-meta">
                {{ video_form.season_number.label_tag }}
                {{ video_form.season_number }}
                {{ video_form.season_number.errors }}
              </div>
              <div class="form-field series-meta">
                {{ video_form.episode_number.label_tag }}
                {{ video_form.episode_number }}
                {{ video_form.episode_number.errors }}
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="selection-summary" data-target="blocked-modal">
              <span class="multi-selected">Nenhum tenant ocultado</span>
              <button type="button">Selecionar contas</button>
            </div>
            <small class="form-hint">
              {{ video_form.blocked_tenants.help_text }}
            </small>
            {{ video_form.blocked_tenants.errors }}
          </div>
          <button class="btn btn-primary" type="submit">Salvar vídeo</button>
        </form>
      </section>
    </div>
  </div>
</section>

<div class="selection-modal" id="blocked-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Ocultar vídeo para</h3>
      <button type="button" class="modal-close">✕</button>
    </div>
    <p class="modal-subtitle">Escolha os tenants que não devem ver este vídeo.</p>
    <div class="modal-options">
      {{ video_form.blocked_tenants.as_widget }}
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary modal-close">Concluir</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("blocked-modal");
    if (!modal) {
      return;
    }
    const toggle = document.querySelector("[data-target='blocked-modal']");
    if (!toggle) {
      return;
    }
    const closeButtons = modal.querySelectorAll(".modal-close");
    const checkboxes = modal.querySelectorAll("input[type=checkbox]");
    const summary = document.querySelector(".selection-summary .multi-selected");

    const updateSummary = () => {
      const selected = Array.from(checkboxes).filter((input) => input.checked);
      if (!summary) {
        return;
      }
      if (!selected.length) {
        summary.textContent = "Nenhum tenant ocultado";
        return;
      }
      summary.textContent = selected
        .map((input) => {
          const label = modal.querySelector(`label[for="${input.id}"]`);
          return label ? label.textContent.trim() : input.value;
        })
        .join(", ");
    };

    const openModal = () => modal.classList.add("open");
    const closeModal = () => modal.classList.remove("open");

    toggle.addEventListener("click", openModal);
    closeButtons.forEach((button) => button.addEventListener("click", closeModal));
    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
    checkboxes.forEach((input) => input.addEventListener("change", updateSummary));
    updateSummary();
  });
</script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(".video-category-tabs .category-tab");
      const sections = document.querySelectorAll(".video-form .form-section[data-section]");
      const categoryField = document.getElementById("id_category");
      const sectionMap = {
        tv: ["tv"],
        movie: ["movie"],
        series: ["series", "movie"],
      };
      const activateCategory = (value) => {
        const visibleSections = sectionMap[value] || [];
        sections.forEach((section) => {
          const shouldShow = visibleSections.includes(section.dataset.section);
          section.classList.toggle("is-visible", shouldShow);
          section.hidden = !shouldShow;
          section.setAttribute("aria-hidden", (!shouldShow).toString());
        });
        tabs.forEach((tab) => {
          const isActive = tab.dataset.categoryTab === value;
          tab.classList.toggle("is-active", isActive);
          tab.setAttribute("aria-selected", isActive ? "true" : "false");
        });
        if (categoryField) {
          categoryField.value = value;
        }
      };
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => activateCategory(tab.dataset.categoryTab));
      });
      const initialCategory = categoryField?.value || "tv";
      activateCategory(initialCategory);
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(".dashboard-tab");
      const sections = document.querySelectorAll("[data-dashboard-section]");
      const setSection = (target) => {
        sections.forEach((section) => {
          const isActive = section.dataset.dashboardSection === target;
          section.classList.toggle("is-visible", isActive);
          section.hidden = !isActive;
          section.setAttribute("aria-hidden", (!isActive).toString());
        });
        tabs.forEach((tab) => {
          const isActive = tab.dataset.dashboardTab === target;
          tab.classList.toggle("is-active", isActive);
          tab.setAttribute("aria-selected", isActive ? "true" : "false");
        });
      };
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => setSection(tab.dataset.dashboardTab));
      });
      setSection("content");
    });
  </script>
{% endblock %}
