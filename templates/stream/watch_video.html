{% extends "base.html" %}

{% block title %}{{ video.title }} | Netfliz{% endblock %}

{% block content %}
<section class="panel video-player">
  <header>
    <h1>{{ video.title }}</h1>
    <p>{{ video.description }}</p>
    <a class="btn btn-secondary" href="{% url 'stream:tenant-portal' %}">
      Voltar ao catálogo</a>
  </header>
  <div class="player">
    <video
      controls
      poster="{{ video.cover_url }}"
      class="responsive {% if video.rotate_180 %}rotate-180{% endif %}"
      data-progress="{{ progress_position|default:0 }}"
      data-rotate="{{ video.rotate_180|yesno:'1,0' }}"
    >
      <source src="{{ video_stream_url }}" type="{{ video.stream_mime }}" />
      Seu navegador não suporta este formato.
    </video>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const videoElement = document.querySelector(".player video");
    const progressUrl = "{{ progress_url }}";
    const progressAttr = videoElement?.dataset.progress || "0";
    const initialPosition = parseFloat(progressAttr.toString().replace(",", ".")) || 0;

    if (!progressUrl || !videoElement) {
      return;
    }

    const loadHlsSource = () => {
      const sourceUrl = "{{ video_stream_url }}";
      const canPlayNative = videoElement.canPlayType("application/vnd.apple.mpegurl");
      if (canPlayNative) {
        videoElement.src = sourceUrl;
        return;
      }
      if (window.Hls && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(sourceUrl);
        hls.attachMedia(videoElement);
      } else {
        videoElement.src = sourceUrl;
      }
    };

    loadHlsSource();

    const getCookie = (name) => {
      const matches = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));
      return matches ? decodeURIComponent(matches[1]) : "";
    };

    const sendProgress = (position) => {
      fetch(progressUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ position }),
      }).catch(() => {});
    };

    const applyInitialPosition = () => {
      if (initialPosition <= 0) {
        return;
      }
      if (!isNaN(videoElement.duration) && videoElement.duration > 0) {
        videoElement.currentTime = Math.min(initialPosition, Math.max(0, videoElement.duration - 0.3));
      } else {
        videoElement.currentTime = initialPosition;
      }
    };

    videoElement.addEventListener("loadedmetadata", applyInitialPosition);
    videoElement.addEventListener("durationchange", applyInitialPosition);
    if (videoElement.readyState > 0) {
      applyInitialPosition();
    }

    let updateTimer;
    const throttleUpdate = () => {
      if (updateTimer) {
        return;
      }
      updateTimer = setTimeout(() => {
        sendProgress(videoElement.currentTime);
        updateTimer = null;
      }, 4000);
    };

    videoElement.addEventListener("timeupdate", throttleUpdate);
    const persistPosition = () => sendProgress(videoElement.currentTime);
    videoElement.addEventListener("pause", persistPosition);
    videoElement.addEventListener("ended", persistPosition);
    window.addEventListener("beforeunload", persistPosition);

    const handleFullscreenRotation = () => {
      const fullscreenElement =
        document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.mozFullScreenElement ||
        document.msFullscreenElement;
      const isFullscreen = fullscreenElement === videoElement;
      if (isFullscreen) {
        videoElement.classList.add("force-fullscreen-rotate");
      } else {
        videoElement.classList.remove("force-fullscreen-rotate");
      }
    };

    document.addEventListener("fullscreenchange", handleFullscreenRotation);
    document.addEventListener("webkitfullscreenchange", handleFullscreenRotation);
    document.addEventListener("mozfullscreenchange", handleFullscreenRotation);
    document.addEventListener("MSFullscreenChange", handleFullscreenRotation);
    handleFullscreenRotation();
  });
</script>
{% endblock %}
